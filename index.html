<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene
      renderer="logarithmicDepthBuffer: true;"
      embedded
      loading-screen="enabled: false;"
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      <a-assets>
        <a-asset-item id="animated-asset" src="LogoCelsiaGLB3.glb"></a-asset-item>
      </a-assets>

      <a-entity
        id="target-model"
        look-at="[gps-camera]"
        animation-mixer="loop: repeat"
        gltf-model="#animated-asset"
        scale="1 1 1"
        gps-entity-place="latitude: 3.34066939; longitude: -76.52944226;"
        visible="false"
      ></a-entity>

      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      const model = document.querySelector("#target-model");
      const camera = document.querySelector("[gps-camera]");

      camera.addEventListener("gps-camera-update-position", (e) => {
        const userLat = e.detail.position.latitude;
        const userLon = e.detail.position.longitude;

        const targetLat = 3.34066939;
        const targetLon = -76.52944226;

        const distance = getDistanceFromLatLonInMeters(userLat, userLon, targetLat, targetLon);

        if (distance < 3) {
          model.setAttribute("visible", "true");
        } else {
          model.setAttribute("visible", "false");
        }
      });

      // Haversine formula to calculate distance in meters
      function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // Earth's radius in meters
        const φ1 = (lat1 * Math.PI) / 180;
        const φ2 = (lat2 * Math.PI) / 180;
        const Δφ = ((lat2 - lat1) * Math.PI) / 180;
        const Δλ = ((lon2 - lon1) * Math.PI) / 180;

        const a =
          Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
          Math.cos(φ1) * Math.cos(φ2) *
          Math.sin(Δλ / 2) * Math.sin(Δλ / 2);

        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c;
      }
    </script>
  </body>
</html>
